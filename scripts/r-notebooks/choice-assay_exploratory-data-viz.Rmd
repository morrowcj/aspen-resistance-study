---
title: "Choice Assay Exploratory Data Visualization"
output: html_notebook
---

# Intro

This document is where I will conduct preliminary data visualization and analysis for the choice assay experiment.

# Setup

```{r setup, include = FALSE}
# getwd() 
knitr::opts_knit$set(root.dir = normalizePath("../.."))  # should change the working directory to the containing dir.
# getwd()  # returns correct. dir
knitr::opts_knit$get("root.dir")  # returns 'Users/Me/Docs/Proj'
```

```{bash, include=FALSE}
#bash scripts/update-data.sh
```

load R libraries:

```{r libraries, message=TRUE, warning=TRUE, include=FALSE}
library(ggplot2)
library(dplyr)
library(data.table)
library(car)
```

Define functions:

```{r functions}
# function to provide linear equation from a model. 
lm_eqtn <- function(model,x=NULL){
  ## extract model parameters
  incpt <- coef(model)[1]
  slope <- coef(model)[2]
  summ <- summary(model)
  r.sqr <- summ$r.squared
  adj.r.sqr <- summ$ajd.r.squared
  
  ## if x is not provided, print the equation as text
  if(is.null(x)){
    equation <- paste0("y=",round(slope,3),"*x+(",round(incpt,3),"); r^2=",round(r.sqr,4))
    return(noquote(equation))
  ## if x is given, calculate the predicted value
  } else {
    y <- as.vector((x*slope)+incpt)
    return(y)
  }
}

# lm_eqtn(model)
```

# Data exploration

load in the data:

```{r load data}
# load data
## read in L4 calibration data
larv.calib.data <- read.csv("data/Choice_Assay/larval-calibration-data_L4.csv")
## read in larval calibration data
leaf.calib.data <- read.csv("data/Choice_Assay/leaf-calibration-data.csv")
## read in experiment data
choice.assay.data <- read.csv("data/Choice_Assay/leaf-and-larvae-data_long.csv")
## redifine the class of specific columns
choice.assay.data <- within(choice.assay.data,{
  genet.lf <- as.factor(genet.lf)
})
leaf.calib.data <- within(leaf.calib.data,{
  Genet <- as.factor(Genet)
  group <- as.factor(group)
})

```

## Larval Calibration

define larval calibration model:

```{r larval calibration model}
# declare linear model for larval calibration (wet-dry mass)
larv.calib.model <- lm(larv.calib.data,formula = drymass_mg~wetmass_mg)

# plot dry~wet mass
ggplot(data = larv.calib.data, aes(y = drymass_mg, x = wetmass_mg))+
  geom_point() + #add points to the plot
  stat_smooth(method = "lm") +  #add a trendline
  labs(title = "choice assay larval calibration curve")+
  annotate("text",label = lm_eqtn(larv.calib.model),x = 60, y = 14)
  

# summarize model (R^2)
summary(larv.calib.model)
```

This calibration should work perfectly. The line fits the data well.

Calculate larval drymass:

```{r calculate larval drymass}
# calculate the estimated drymasses
choice.assay.data$gm.init.drymass_mg <- lm_eqtn(larv.calib.model, choice.assay.data$gm.init.wetmass_mg)

# visualize this new variable:
plot(choice.assay.data$gm.init.drymass_mg~choice.assay.data$gm.init.wetmass_mg)
```

## Leaf Calibration

### Linear cal. method

First, we'll try the linear calibration model for leaf wet-dry mass:

```{r leaf cal. linear}
# declare linear model for leaf calibration (wet-dry mass)
leaf.calib.model <- lm(leaf.calib.data,formula = agg.drymass_mg~agg.wetmass_mg + group)

# plot dry~wet mass
ggplot(data = leaf.calib.data, aes(y = agg.drymass_mg, x = agg.wetmass_mg))+
  labs(title = "choice assay leaf calibration curve")+
  geom_point(aes(col=group)) + #add points to the plot
  stat_smooth(method = "lm") +  #add a trendline
  annotate("text",label = lm_eqtn(leaf.calib.model,x=NULL),x = 750, y = 550)
  
# summarize model (R^2)
summary(leaf.calib.model)$r.squared

# summary(lm(leaf.calib.data[-49,],formula = agg.drymass_mg~agg.wetmass_mg))$r.squared
```

Because there is substantial variation in drymass/wetmass, I decided to look at the coeficients separated by growth category (group):

### Grouped cal. method

```{r leaf cal. by group}
anova(leaf.calib.model)

## look at the model coefficients by group
  ## library(data.table) allows the following
dat.tab <- data.table(leaf.calib.data)
coef.tab <- dat.tab[,list(intcpt = coef(lm(agg.drymass_mg ~ agg.wetmass_mg))[1],
                          slope = coef(lm(agg.drymass_mg ~ agg.wetmass_mg))[2],
                          r.sqr = summary(lm(agg.drymass_mg ~ agg.wetmass_mg))$r.squared),
              by = group]

within(coef.tab,{
  r.sqr <-  round(r.sqr,4)
  slope <-  round(slope,4)
  intcpt <-  round(intcpt,4)
})

ggplot(data = leaf.calib.data, 
       aes(y = agg.drymass_mg, 
           x = agg.wetmass_mg, 
           group = group)) +
  labs(title = "Wet-dry leaf calibration model",xlab = "aggregate wet mass (mg)", ylab = "aggregate dry mass (mg)") +     
  geom_point(aes(col = group)) + #add points to the plot
  stat_smooth(method = "lm", aes(col = group)) #add a trendline
  
```


There seems to be a significant effect of group on water loss.

#### Outlier testing

There may be an outlier in the calibration data:

```{r leaf cal. by group no outliers, include=TRUE}
cal.outliers <- as.numeric(names(outlierTest(leaf.calib.model)[[1]]))

leaf.calib.model2 <- lm(leaf.calib.data[-cal.outliers],formula = agg.drymass_mg~agg.wetmass_mg + group)

anova(leaf.calib.model2)

## look at the model coefficients by group
dat.tab2 <- data.table(leaf.calib.data[-cal.outliers,])
coef.tab2 <- dat.tab2[,list(intcpt = coef(lm(agg.drymass_mg ~ agg.wetmass_mg))[1],
                          slope = coef(lm(agg.drymass_mg ~ agg.wetmass_mg))[2],
                          r.sqr = summary(lm(agg.drymass_mg ~ agg.wetmass_mg))$r.squared),
              by = group]

within(coef.tab2,{
  r.sqr <-  round(r.sqr,4)
  slope <-  round(slope,4)
  intcpt <-  round(intcpt,4)
})

ggplot(data = leaf.calib.data[-cal.outliers,], 
       aes(y = agg.drymass_mg, 
           x = agg.wetmass_mg, 
           group = group)) +
  labs(title = "Wet-dry leaf calibration model",xlab = "aggregate wet mass (mg)", ylab = "aggregate dry mass (mg)") +     
  geom_point(aes(col = group)) + #add points to the plot
  stat_smooth(method = "lm", aes(col = group)) #add a trendline
  
```

Removing the potential outlier does not affect the curve enough to justify removing it. The full calibration data should be used.

The r-squared values are a bit better when grouped linear models are used over the traditional linear model, but it still may be best to use 1 correction factor per genotype (which is the average drymass/wetmass for 4-5 leaves per genet.)

```{r genet cal. key}
leaf.cal_lookup.tab <- leaf.calib.data %>% select(Genet,group,biomass.proportion_dry.div.wet) %>% group_by(Genet,group) %>% summarise(mean.biomass.prop=mean(biomass.proportion_dry.div.wet,na.rm = TRUE))

head(leaf.cal_lookup.tab)
```

Here we merge in those genet-based calibration values:

```{r merge group cal. key}
# merge the lookup table into the choice assay data
choice.assay.data <- merge(choice.assay.data,leaf.cal_lookup.tab,by.x = "genet.lf",by.y = "Genet",all.x = TRUE)

# add in coeficients from grouped model
choice.assay.data <- merge(choice.assay.data,coef.tab,by = "group",all.x = TRUE)
```

Next I will estimate the initial dry mass according to the various calibration methods and then compare them:

### Calculate leaf drymass estimates

```{r initial dry mass calc.}
# calculate initial drymass

## full model
choice.assay.data$lf.init.drymass_no.calib_mg <- lm_eqtn(model = leaf.calib.model, choice.assay.data$lf.init.wetmass_mg)

dif0 <- choice.assay.data$lf.init.drymass_no.calib_mg - choice.assay.data$lf.end.drymass_mg

prop0 <- length(which(dif0<0))/length(dif0)

summary(dif0)

## Genet method
choice.assay.data$lf.init.drymass_genet.calib_mg <- choice.assay.data$mean.biomass.prop*choice.assay.data$lf.init.wetmass_mg

dif1 <- choice.assay.data$lf.init.drymass_genet.calib_mg - choice.assay.data$lf.end.drymass_mg

prop1 <- length(which(dif1<0))/length(dif1)

summary(dif1)

# group method
choice.assay.data$lf.init.drymass_group.calib_mg <- (choice.assay.data$lf.init.wetmass_mg*choice.assay.data$slope)+choice.assay.data$intcpt

dif2 <- choice.assay.data$lf.init.drymass_group.calib_mg - choice.assay.data$lf.end.drymass_mg

prop2 <- length(which(dif2<0))/length(dif2)

summary(dif2)

boxplot(dif0,dif1,dif2,names = c("linear","genet","grouped linear"),main = "Estimated Leaf Biomass Consumed \n by calibration method",ylab = "leaf biomass lost (mg)",xlab = "calibration type")
abline(h = 0, col = "grey", lty = 2)

# boxplot(choice.assay.data$lf.init.drymass_genet.calib_mg,choice.assay.data$lf.init.drymass_group.calib_mg,names = c("genet calibration","group calibration"),main = "Estimated Initial Leaf Biomass (by calibration method)",ylab = "leaf biomass (mg)")
```

The comparison shows that both linear methods estimate fewer observations with "leaf biomass lost" < 0.
Additionally, the grouped linear method estimates even less negative valuse than the original linear model: 

```{r prop. of obs. with neg. biomass lost}
round(cbind("linear" = prop0, "genet" = prop1, "grp.lin" = prop2),digits = 4)
```

#### Outlier test:

```{r lf. cal. outlier tests}
model <- lm(choice.assay.data$lf.end.drymass_mg ~ choice.assay.data$lf.init.drymass_group.calib_mg)


## from the 'car' package:
outlr.test <- outlierTest(model,n.max = Inf)
outlr.test
# list of outliers (as rows of original dataset)
outliers <- as.numeric(names(outlr.test[[1]]))

# Show the biomass difference
outlier.val <- round(with(choice.assay.data[outliers,], {lf.init.drymass_group.calib_mg - lf.end.drymass_mg}),digits = 2)
```

When we compare initial mass to final mass, Observation(s) `outliers` is a serious outlier (this is true no matter which calibration you use). When using the grouped calibration, the estimated leaf area consumed is `outlier.val`

This anamoly is likely due to a recording error in the leaf's mass. I will test to see the effect of removing the observations:

```{r outlier effect}
# nrow(choice.assay.data)
# choice.assay.data[c(8,9),]

model <- lm(choice.assay.data$lf.end.drymass_mg ~ choice.assay.data$lf.init.drymass_group.calib_mg + choice.assay.data$group + choice.assay.data$gm.init.drymass_mg)

cat("original r-squared:\n")
summary(model)$r.squared

plot(choice.assay.data$lf.end.drymass_mg ~ choice.assay.data$lf.init.drymass_group.calib_mg,
     xlab = "initial leaf drymass (mg)",
     ylab = "final leaf drymass (mg)",
     main = "full data"
     )
suppressWarnings(abline(model))
abline(c(0,1),col = "red")

## reove outliers
choice.assay.data2 <- choice.assay.data[c(-outliers),]

# nrow(choice.assay.data2)

model2 <- lm(choice.assay.data2$lf.end.drymass_mg ~ choice.assay.data2$lf.init.drymass_group.calib_mg + choice.assay.data2$group + choice.assay.data2$gm.init.drymass_mg)

cat("new r-squared:\n")
summary(model2)$r.squared

plot(choice.assay.data2$lf.end.drymass_mg ~ choice.assay.data2$lf.init.drymass_group.calib_mg,
     xlab = "initial leaf drymass (mg)",
     ylab = "final leaf drymass (mg)",
     main = "without outlier"
     )
suppressWarnings(abline(model2))
abline(c(0,1),col = "red")

```

There seems to be a strong effect of removing the potential outlier, which may justify removing the observation from the analysis.

#### No molting

First, I want to make sure that there isn't any obvious reason for a decrease in area.

```{r compare without molting}
data.reduced <- choice.assay.data[choice.assay.data$molting_bin<1,]

data.reduced$leaf.mass.consumed <- dif.red <- (data.reduced$lf.init.drymass_group.calib_mg - data.reduced$lf.end.drymass_mg)

prop.red <- length(which(dif.red < 0))/length(dif.red)

gen.dif.red <- (data.reduced$lf.init.drymass_genet.calib_mg - data.reduced$lf.end.drymass_mg)

prop.genet.red <- length(which(gen.dif.red < 0))/length(gen.dif.red)

boxplot(dif0,dif1,dif2,dif.red,gen.dif.red,names = c("linear","genet","grouped\n linear", "no.molt\ngrouped","no.molt\n genet"),main = "Estimated Leaf Biomass Consumed \n by calibration method",ylab = "leaf biomass lost (mg)",xlab = "calibration type")
abline(h = 0, col = "grey", lty = 2)
```

```{r no molting prop}
round(cbind("linear" = prop0, "genet" = prop1, "grp.lin" = prop2, prop.red, prop.genet.red),digits = 4)
```

```{r prop. of molting}
length(which(choice.assay.data$molting_bin==1))/nrow(choice.assay.data)
```

## Visualization

```{r leaves per dish}
leaves <- data.reduced %>% group_by(Dish.ID) %>% summarise("leaves" = length(genet.lf))

data.reduced <- merge(data.reduced,leaves,by = "Dish.ID")
```

Here I'll add in the treatment group which is the combination of all groups
present in one dish.

```{r treatment group}
# create the empty key
treatment.key <- data.frame("Dish.ID" = data.reduced$Dish.ID, "treatment" = NA)
# loop over all dishes and extract the groups present
for (ID in data.reduced$Dish.ID){
  trts <- unique(data.reduced$group[which(data.reduced$Dish.ID == ID)])
  trts <- sort(trts)
  ## paste the dishes groups together into one string
  treatment <- paste(trts, collapse = ".")
  ## at the treatment string to the key
  treatment.key$treatment[which(treatment.key$Dish.ID == ID)] <- treatment
}

## check that there are only 4 treatments
stopifnot(length(unique(treatment.key$treatment))==4)
## if the IDs aren't equal, stop.
stopifnot(all.equal(treatment.key$Dish.ID,data.reduced$Dish.ID))
## same for number of observations
stopifnot(nrow(treatment.key) == nrow(data.reduced))

match.index <- match(x = treatment.key$Dish.ID, table = data.reduced$Dish.ID)

data.reduced$treatment <- factor(treatment.key$treatment,levels = unique(treatment.key$treatment))

data.reduced %>% nrow()

## show that it worked:
data.reduced[data.reduced$Dish.ID %in% data.reduced$Dish.ID[c(1,5,31,80)],] %>% select(Dish.ID, group, treatment)

## treatment composition table
(treatment.n <- data.reduced %>% group_by(treatment) %>% summarise(n = length(Dish.ID)))
```

### Plots

Let's see how our treatments influenced consumption:

```{r plot the groups}
ggplot(data = data.reduced, aes(x = jitter(as.numeric(treatment)), y = leaf.mass.consumed, fill = group)) +
  geom_point(aes(col = group)) + labs(title = "leaf biomass consumed by treatment", y = "biomass consumed")

## summarize the grouped data by mean 
plot.table <- data.reduced %>% group_by(treatment, group) %>% summarize(mean.consumed = mean(leaf.mass.consumed), sd.consumed = sd(leaf.mass.consumed))


(gp <- ggplot(data = plot.table, aes(x = treatment, y = mean.consumed, fill = group)) +
  geom_bar(stat = "identity", position = "dodge", col = "black")+
    labs(title = "leaf biomass consumed by treatment", y = "biomass consumed")
  )
  
  
gp +geom_errorbar(aes(ymin = mean.consumed - sd.consumed,
                    ymax = mean.consumed + sd.consumed),
                width = .2,
                position = position_dodge(.9))
```

There is a potential outlier according to the first graph above.

```{r}
potential.outlier <- which(data.reduced$leaf.mass.consumed > 100)

data.reduced[potential.outlier,]
```

```{r}
triplets.filtered <- data.reduced %>% filter(leaf.mass.consumed <= 100, treatment == "fast.med.slow")

triplets.means <- triplets.filtered %>% group_by(group) %>% 
  summarise(mean.consumed = mean(leaf.mass.consumed), sd.consumed = sd(leaf.mass.consumed))

ggplot(data = triplets.means, aes(y = mean.consumed, x = group)) +
  geom_bar(aes(fill = group), stat = "identity", position = "dodge") + 
    labs(title = "leaf biomass consumed by treatment", subtitle = "(choice of all 3)", y = "biomass consumed") +
  geom_errorbar(aes(ymin = mean.consumed - sd.consumed,
                    ymax = mean.consumed + sd.consumed),
                width = .2,
                position = position_dodge(.9))
```


```{r update data}
write.csv(choice.assay.data,file = "data/Choice_Assay/leaf-and-larvae-data_long_calibrated.csv")
```

