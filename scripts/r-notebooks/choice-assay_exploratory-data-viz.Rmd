---
title: "Choice Assay Exploratory Data Visualization"
output: html_notebook
---

```{r setup, include = FALSE}
# getwd() 
knitr::opts_knit$set(root.dir = normalizePath("../.."))  # should change the working directory to the containing dir.
# getwd()  # returns correct. dir
knitr::opts_knit$get("root.dir")  # returns 'Users/Me/Docs/Proj'
```

```{bash, include=FALSE}
bash scripts/update-data.sh
```

```{r libraries, message=TRUE, warning=TRUE, include=FALSE}
library(ggplot2)
library(dplyr)
# library(ggpmisc)
```


```{r functions}
# function to provide linear equation from a model. 
lm_eqtn <- function(model,x=NULL){
  ## extract model parameters
  incpt <- coef(model)[1]
  slope <- coef(model)[2]
  summ <- summary(model)
  r.sqr <- summ$r.squared
  adj.r.sqr <- summ$ajd.r.squared
  
  ## if x is not provided, print the equation as text
  if(is.null(x)){
    equation <- paste0("y=",round(slope,3),"*x+(",round(incpt,3),"); r^2=",round(r.sqr,4))
    return(noquote(equation))
  ## if x is given, calculate the predicted value
  } else {
    y <- as.vector((x*slope)+incpt)
    return(y)
  }
}

# lm_eqtn(model)
```


```{r}
# load data
## read in L4 calibration data
larv.calib.data <- read.csv("data/Choice_Assay/larval-calibration-data_L4.csv")
## read in larval calibration data
leaf.calib.data <- read.csv("data/Choice_Assay/leaf-calibration-data.csv")
## read in experiment data
choice.assay.data <- read.csv("data/Choice_Assay/leaf-and-larvae-data_long.csv")
## redifine the class of specific columns
choice.assay.data <- within(choice.assay.data,{
  genet.lf <- as.factor(genet.lf)
})
leaf.calib.data <- within(leaf.calib.data,{
  Genet <- as.factor(Genet)
  group <- as.factor(group)
})

```

```{r larval calibration}
# declare linear model for larval calibration (wet-dry mass)
larv.calib.model <- lm(larv.calib.data,formula = drymass_mg~wetmass_mg)

# plot dry~wet mass
## load ggplot2
library(ggplot2)
ggplot(data = larv.calib.data, aes(y = drymass_mg, x = wetmass_mg))+
  geom_point() + #add points to the plot
  stat_smooth(method = "lm") +  #add a trendline
  labs(title = "choice assay larval calibration curve")+
  annotate("text",label = lm_eqtn(larv.calib.model),x = 60, y = 14)
  

# summarize model (R^2)
summary(larv.calib.model)
```

This calibration should work perfectly. 

```{r}
# calculate the estimated drymasses
choice.assay.data$gm.init.drymass_mg <- lm_eqtn(larv.calib.model, choice.assay.data$gm.init.wetmass_mg)

# visualize this new variable:
plot(choice.assay.data$gm.init.drymass_mg~choice.assay.data$gm.init.wetmass_mg)
```


```{r leaf calibration}
# declare linear model for leaf calibration (wet-dry mass)
leaf.calib.model <- lm(leaf.calib.data,formula = agg.drymass_mg~agg.wetmass_mg + group)

# plot dry~wet mass
## load ggplot2
library(ggplot2)
ggplot(data = leaf.calib.data, aes(y = agg.drymass_mg, x = agg.wetmass_mg))+
  labs(title = "choice assay leaf calibration curve")+
  geom_point(aes(col=group)) + #add points to the plot
  stat_smooth(method = "lm") +  #add a trendline
  annotate("text",label = lm_eqtn(leaf.calib.model,x=NULL),x = 750, y = 550)
  

# summarize model (R^2)
summary(leaf.calib.model)$r.squared

# summary(lm(leaf.calib.data[-49,],formula = agg.drymass_mg~agg.wetmass_mg))$r.squared
```

Because there is substantial variation in drymass/wetmass, I decided to look at the coeficients separated by group:

```{r leaf cal. by group}
anova(leaf.calib.model)

## look at the model coefficients by group
library(data.table) # data table library allows the following
dat.tab <- data.table(leaf.calib.data)
coef.tab <- dat.tab[,list(intcpt = coef(lm(agg.drymass_mg ~ agg.wetmass_mg))[1],
                          slope = coef(lm(agg.drymass_mg ~ agg.wetmass_mg))[2],
                          r.sqr = summary(lm(agg.drymass_mg ~ agg.wetmass_mg))$r.squared),
              by = group]

within(coef.tab,{
  r.sqr <-  round(r.sqr,4)
  slope <-  round(slope,4)
  intcpt <-  round(intcpt,4)
})

ggplot(data = leaf.calib.data, 
       aes(y = agg.drymass_mg, 
           x = agg.wetmass_mg, 
           group = group)) +
  labs(title = "Wet-dry leaf calibration model",xlab = "aggregate wet mass (mg)", ylab = "aggregate dry mass (mg)") +     
  geom_point(aes(col = group)) + #add points to the plot
  stat_smooth(method = "lm", aes(col = group)) #add a trendline
  
```

There seems to be a significant effect of group on water loss.

The r-squared values are a bit better this way, but it still may be best to use 1 correction factor per genotype (which is the average drymass/wetmass for 4-5 leaves per genet.)

```{r genet key}
leaf.cal_lookup.tab <- leaf.calib.data %>% select(Genet,group,biomass.proportion_dry.div.wet) %>% group_by(Genet,group) %>% summarise(mean.biomass.prop=mean(biomass.proportion_dry.div.wet,na.rm = TRUE))

head(leaf.cal_lookup.tab)
```

```{r}
# merge the lookup table into the choice assay data
choice.assay.data <- merge(choice.assay.data,leaf.cal_lookup.tab,by.x = "genet.lf",by.y = "Genet",all.x = TRUE)

# add in coeficients from grouped model
choice.assay.data <- merge(choice.assay.data,coef.tab,by = "group",all.x = TRUE)
```

```{r}
# calculate initial drymass

## full model
choice.assay.data$lf.init.drymass_no.calib_mg <- lm_eqtn(model = leaf.calib.model, choice.assay.data$lf.init.wetmass_mg)

dif0 <- choice.assay.data$lf.init.drymass_no.calib_mg - choice.assay.data$lf.end.drymass_mg

prop0 <- length(which(dif0<0))/length(dif0)

summary(dif0)

## Genet method
choice.assay.data$lf.init.drymass_genet.calib_mg <- choice.assay.data$mean.biomass.prop*choice.assay.data$lf.init.wetmass_mg

dif1 <- choice.assay.data$lf.init.drymass_genet.calib_mg - choice.assay.data$lf.end.drymass_mg

prop1 <- length(which(dif1<0))/length(dif1)

summary(dif1)

# group method
choice.assay.data$lf.init.drymass_group.calib_mg <- (choice.assay.data$lf.init.wetmass_mg*choice.assay.data$slope)+choice.assay.data$intcpt

dif2 <- choice.assay.data$lf.init.drymass_group.calib_mg - choice.assay.data$lf.end.drymass_mg

prop2 <- length(which(dif2<0))/length(dif2)

summary(dif2)

boxplot(dif0,dif1,dif2,names = c("linear","genet","grouped linear"),main = "Estimated Leaf Biomass Consumed \n by calibration method",ylab = "leaf biomass lost (mg)",xlab = "calibration type")
abline(h = 0, col = "grey", lty = 2)

# boxplot(choice.assay.data$lf.init.drymass_genet.calib_mg,choice.assay.data$lf.init.drymass_group.calib_mg,names = c("genet calibration","group calibration"),main = "Estimated Initial Leaf Biomass (by calibration method)",ylab = "leaf biomass (mg)")
```

When we compare initial mass to final mass, Observation 8 is a serious outlier (this is true no matter which calibration you use):

```{r}
model <- lm(choice.assay.data$lf.end.drymass_mg ~ choice.assay.data$lf.init.drymass_group.calib_mg)


library(car)
outlr.test <- outlierTest(model,n.max = Inf)
outlr.test
# list of outliers (as rows of original dataset)
outliers <- as.numeric(names(outlr.test[[1]]))

# Show the biomass difference
cat("biomass consumed =", with(choice.assay.data[outliers,], {lf.init.drymass_group.calib_mg - lf.end.drymass_mg}),"mg\n")
```

This anamoly is likely due to a recording error in the leaf's mass. I will test to see the effect of removing the observations:

```{r}
# nrow(choice.assay.data)
# choice.assay.data[c(8,9),]

model <- lm(choice.assay.data$lf.end.drymass_mg ~ choice.assay.data$lf.init.drymass_group.calib_mg + choice.assay.data$group + choice.assay.data$gm.init.drymass_mg)

cat("original r-squared:\n")
summary(model)$r.squared

plot(choice.assay.data$lf.end.drymass_mg ~ choice.assay.data$lf.init.drymass_group.calib_mg)
suppressWarnings(abline(model))
abline(c(0,1),col = "red")

## reove outliers
choice.assay.data2 <- choice.assay.data[c(-outliers),]

# nrow(choice.assay.data2)

model2 <- lm(choice.assay.data2$lf.end.drymass_mg ~ choice.assay.data2$lf.init.drymass_group.calib_mg + choice.assay.data2$group + choice.assay.data2$gm.init.drymass_mg)

cat("new r-squared:\n")
summary(model2)$r.squared

plot(choice.assay.data2$lf.end.drymass_mg ~ choice.assay.data2$lf.init.drymass_group.calib_mg)
suppressWarnings(abline(model2))
abline(c(0,1),col = "red")

```


```{r update data}
write.csv(choice.assay.data,file = "data/Choice_Assay/leaf-and-larvae-data_long_calibrated.csv")
```

